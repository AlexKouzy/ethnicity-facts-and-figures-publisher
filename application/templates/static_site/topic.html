{% extends "static_site/_base.html" %}
{% block page_title %}{{ topic.title }} - GOV.UK Ethnicity facts and figures{% endblock %}
{% block meta_title %}{{ topic.title }}{% endblock %}

{% block google_analytics %}ga('set','contentGroup1','Topic'){% endblock %}
{% block main_content %}

<main id="content">
	{%  include 'static_site/_phase_banner.html' %}
	<div class="breadcrumbs">
		<ol>
			<li> <a href="/">Ethnicity facts and figures</a></li>
		</ol>
	</div>

	<div class="grid-row">
		<div class="column-two-thirds">
			<h1 class="heading-xlarge">
				{{ topic.title }}
			</h1>
            {% if topic.additional_description  %}
                <p>
                    {{ topic.additional_description | render_markdown  }}
                </p>
            {% endif %}
		</div>
	</div>

	<div class="grid-row">

        {% if static_mode %}
            <div class="column-two-thirds">
        {% else %}
            <div class="column-full">
        {% endif %}

            <div class="accordion">
            <div class="container">
                {% for subtopic in subtopics %}

                    {% if measures[subtopic.guid] %}
                            <div class="accordion-section">
                                <div class="accordion-section-header" data-on="click" data-event-category="Accordion" data-event-action="Section opened" data-event-label="{{ subtopic.title }}" >
                                    <h2 class="heading-medium">
                                        {{ subtopic.title }}
                                    </h2>
                                </div>

                                <div class="accordion-section-body">

                                    {% if static_mode %}

                                        <ul class="links">
                                            {% for m in measures[subtopic.guid] %}
                                                <li>
                                                    <a href="{{ url_for('static_site.measure_page',
                                                                        topic=topic.uri,
                                                                        subtopic=subtopic.uri,
                                                                        measure=m.uri,
                                                                        version='latest') }}">{{ m.title }}
                                                    </a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        {% include 'cms/_measures_with_version_history.html' %}
                                         <p><a href="{{ url_for('cms.create_measure_page', topic=topic.guid, subtopic=subtopic.guid) }}" class="button">Add a
        measure to {{ subtopic.title }}</a>
      </p>
                                    {% endif %}
                                </div>
                            </div>
                    {% endif %}
                {% endfor %}
			</div>
		</div>
	</div>
</div>
</main>

{% endblock %}


{% block body_end_more %}

    <script type="text/javascript">

        var orderMeasures = function(table) {
            var positions = []
            // skip first row which is table header
            for(var i = 1; i < table.rows.length; i++) {
                 if (table.rows[i].dataset.guid && table.rows[i].dataset.version) {
                    positions.push({"position": i - 1,
                                    "guid": table.rows[i].dataset.guid,
                                    "version": table.rows[i].dataset.version})
                }
            }

            $.ajax({
                type: 'POST',
                url: "{{ url_for('cms.set_measure_order') }}",
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({"positions": positions}),
                success: function (data) {
                    console.log('Set order for measures:', positions);
                },
                error: function (data) {
                    console.log('Error setting order for measures:', positions);
                }
            });
        };

        var tables = document.querySelectorAll('table');
        tables.forEach(function (table) {
            // only apply to tables with more than one measure. First row is headers.
            if (table.rows.length > 2) {
                var r = new ReorderableRows(table);
                r.onDrop = orderMeasures
            }
        })

    </script>

{% endblock %}