---
title: "Extracting Ethnicities"
author: "Tom Ridd"
date: "18/08/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Generating data files

This is an R Markdown document "knitted" using extracting_ethnicities.Rmd and setting out how to use R to generate a full list of ethnicities used in the rdu charts and tables. We will begin by importing the production database onto your local machine, a generally useful activity in any case.

##### 1.1. Drop your local database
```
psql
DROP DATABASE rdcms;
```
and recreate it
```
./manage db upgrade
```
##### 1.2. Import the production database
Username and password can be found through the heroku database screen under "DATABASE CREDENTIALS"
```
pg_dump --no-acl --no-owner -h {EC2_HOST_NAME} -U {USER_NAME} -t db_page -t db_dimension --data-only {DB_USER_NAME} > file.dump
```
```
psql -d rdcms < file.dump
```
##### 1.3. Extract a list of the source data we use to generate charts and tables
Go to the data folder and generate the data files
```
psql -d rdcms -t -A -F $'\t' -f get_chart_data.sql > chart_data.tsv
psql -d rdcms -t -A -F $'\t' -f get_table_data.sql > table_data.tsv
```

## 2. Process the data into tables
We read the files into data frames, add on a variable so we can tell where each variable has come from and merge
``` {r read_data}
chart_data <- read.table(file = 'data/chart_data.tsv', sep = '\t', quote = "", stringsAsFactors = FALSE)
colnames(chart_data) <- c("guid", "measure", "row_no", "col_no", "value")
chart_data['origin'] <- rep('chart', nrow(chart_data))

table_data <- read.table(file = 'data/table_data.tsv', sep = '\t', quote = "", stringsAsFactors = FALSE)
colnames(table_data) <- c("guid", "measure", "row_no", "col_no", "value")
table_data['origin'] <- rep('table', nrow(table_data))

data <- rbind(chart_data, table_data)
colnames(data) <- c("dimension", "measure", "row_no", "col_no", "value", "origin")

rm(chart_data)
rm(table_data)

```

## 3. Process the data into tables
``` {r process_data}
first_line_list <- data[data$row_no == 1 & data$col_no == 1,c('dimension','origin')]

results = data.frame(ethnicity=character(), stringsAsFactors = FALSE)
for(i in 1:nrow(first_line_list)) {
  
  dimension = first_line_list$dimension[i]
  origin = first_line_list$origin[i]
  headers = data[data$dimension == dimension & data$origin == origin & data$row_no == 1, ]
  cells = data[data$dimension == dimension & data$origin == origin & data$row_no > 1, ]
  
  # this is a rough work where we just grab any column with ethnic, race in it and grab all values
  # that is going to give us the opportunity for non ethnicities to fall in so we will need to do some 
  # cleaning - much cleaning in fact
  a <- grep('ethnic', headers$value, ignore.case = TRUE)
  b <- grep('race', headers$value, ignore.case = TRUE)
  c <- grep('racial', headers$value, ignore.case = TRUE)
  ethnic_columns <- c(a,b,c)
  
  for(j in 1:nrow(cells)) {
    ethnicity_values = unique(data.frame(ethnicity = cells$value[cells$col_no %in% ethnic_columns], 
                                         stringsAsFactors = FALSE))
    results <- unique(rbind(results, ethnicity_values))
  }
}

results



write.csv(file = 'outputs/results.csv', results$ethnicity)
```


Now lets do some cleaning

```{r cleaning}

# returns string w/o leading or trailing whitespace
trim <- function (x) gsub("^\\s+|\\s+$", "", x)
cleaned <- sapply(results, tolower)
cleaned <- sapply(cleaned, trim)
cleaned <- unique(cleaned)
cleaned <- sort(cleaned)

# remove any numbers that have slipped in
clean_nums <- gsub("%", "", gsub(",", "", cleaned))
clean_nums <- data.frame(value = cleaned, notnumber = is.na(as.numeric(clean_nums)), stringsAsFactors = FALSE)
cleaned <- data.frame(ethnicity = clean_nums$value[clean_nums$notnumber == TRUE], stringsAsFactors = FALSE)

# get rid of some inconvenient known values
ignore_these = startsWith(cleaned$ethnicity,"ons ") | startsWith(cleaned$ethnicity,"16+") | startsWith(cleaned$ethnicity,"18+")

cleaned <- cleaned[ignore_these == FALSE,]
write.csv(file = 'outputs/results.csv', cleaned)
```
